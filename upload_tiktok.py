#!/usr/bin/env python3
"""
TikTokè‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä½¿ç”¨æ–¹æ³•:
    python upload_tiktok.py --video video.mp4 --title "å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«"

ç’°å¢ƒå¤‰æ•°:
    TIKTOK_SESSIONID: TikTokã®sessionid Cookie
"""

import os
import sys
import argparse
import json
import tempfile
from pathlib import Path
from datetime import datetime


def create_cookies_file(sessionid: str, output_path: str) -> bool:
    """
    sessionidã‹ã‚‰Netscapeå½¢å¼ã®cookies.txtã‚’ç”Ÿæˆ

    Args:
        sessionid: TikTokã®sessionid Cookieå€¤
        output_path: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

    Returns:
        bool: æˆåŠŸæ™‚True
    """
    # Netscape cookies.txtå½¢å¼
    # domain, include_subdomains, path, secure, expiry, name, value
    cookies_content = f"""# Netscape HTTP Cookie File
# This file was generated by upload_tiktok.py

.tiktok.com	TRUE	/	TRUE	1893456000	sessionid	{sessionid}
.tiktok.com	TRUE	/	TRUE	1893456000	sessionid_ss	{sessionid}
"""

    try:
        with open(output_path, 'w') as f:
            f.write(cookies_content)
        return True
    except Exception as e:
        print(f"[TikTok] Cookie file creation error: {e}")
        return False


def generate_tiktok_description(title: str, youtube_description: str = None) -> str:
    """
    TikTokç”¨ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆ

    Args:
        title: å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«
        youtube_description: YouTubeç”¨ã®èª¬æ˜æ–‡ï¼ˆã‚ã‚Œã°ï¼‰

    Returns:
        TikTokç”¨ã®èª¬æ˜æ–‡ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ä»˜ãï¼‰
    """
    # TikTokç”¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼‰
    hashtags = [
        "#å¹´é‡‘",
        "#ã‚·ãƒ‹ã‚¢",
        "#60ä»£",
        "#è€å¾Œ",
        "#ãŠé‡‘ã®è©±",
        "#ç¯€ç´„ç”Ÿæ´»",
    ]

    # ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãã®ã¾ã¾ä½¿ç”¨
    description = f"{title}\n\n{' '.join(hashtags)}"

    return description


def upload_to_tiktok(
    video_path: str,
    title: str,
    sessionid: str,
    youtube_description: str = None
) -> dict:
    """
    TikTokã«å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

    Args:
        video_path: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        title: å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«
        sessionid: TikTokã®sessionid
        youtube_description: YouTubeç”¨ã®èª¬æ˜æ–‡

    Returns:
        dict: çµæœæƒ…å ±
    """
    result = {
        "success": False,
        "error": None,
        "video_path": video_path,
    }

    # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if not os.path.exists(video_path):
        result["error"] = f"Video file not found: {video_path}"
        return result

    # sessionidã®ç¢ºèª
    if not sessionid:
        result["error"] = "TIKTOK_SESSIONID is not set"
        return result

    try:
        # tiktok-uploaderã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        try:
            from tiktok_uploader.upload import upload_video
        except ImportError:
            result["error"] = "tiktok-uploader is not installed. Run: pip install tiktok-uploader"
            return result

        # Cookie ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
        temp_dir = tempfile.mkdtemp()
        cookies_path = os.path.join(temp_dir, "cookies.txt")

        if not create_cookies_file(sessionid, cookies_path):
            result["error"] = "Failed to create cookies file"
            return result

        # TikTokç”¨ã®èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
        description = generate_tiktok_description(title, youtube_description)

        print(f"[TikTok] Uploading: {video_path}")
        print(f"[TikTok] Description: {description[:100]}...")

        # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        # headless=True ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆGitHub Actionsç”¨ï¼‰
        upload_video(
            filename=video_path,
            description=description,
            cookies=cookies_path,
            headless=True,
        )

        result["success"] = True
        result["description"] = description
        print("[TikTok] Upload successful!")

        # Cookie ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        try:
            os.remove(cookies_path)
            os.rmdir(temp_dir)
        except:
            pass

    except Exception as e:
        error_msg = str(e)
        result["error"] = error_msg
        print(f"[TikTok] Upload failed: {error_msg}")

        # ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã®å¯¾å‡¦æ³•ã‚’è¡¨ç¤º
        if "sessionid" in error_msg.lower() or "cookie" in error_msg.lower():
            print("[TikTok] Hint: sessionid may be expired. Please update TIKTOK_SESSIONID.")
        elif "too many" in error_msg.lower():
            print("[TikTok] Hint: Too many uploads. Wait a few hours before trying again.")

    return result


def send_discord_notification(webhook_url: str, result: dict, video_title: str):
    """
    Discordé€šçŸ¥ã‚’é€ä¿¡

    Args:
        webhook_url: Discord Webhook URL
        result: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ
        video_title: å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«
    """
    if not webhook_url:
        return

    try:
        import requests

        if result["success"]:
            message = f"ğŸµ **TikTokæŠ•ç¨¿å®Œäº†**\n\nğŸ“¹ {video_title[:50]}"
        else:
            message = f"âš ï¸ **TikTokæŠ•ç¨¿å¤±æ•—**\n\nğŸ“¹ {video_title[:50]}\nâŒ {result.get('error', 'Unknown error')[:200]}"

        requests.post(
            webhook_url,
            json={"content": message},
            timeout=10
        )
    except Exception as e:
        print(f"[Discord] Notification failed: {e}")


def main():
    parser = argparse.ArgumentParser(description="Upload video to TikTok")
    parser.add_argument("--video", required=True, help="Path to video file")
    parser.add_argument("--title", required=True, help="Video title")
    parser.add_argument("--description", default="", help="YouTube description (optional)")
    parser.add_argument("--sessionid", default=None, help="TikTok sessionid (or use TIKTOK_SESSIONID env)")

    args = parser.parse_args()

    # sessionidã‚’å–å¾—
    sessionid = args.sessionid or os.environ.get("TIKTOK_SESSIONID")

    if not sessionid:
        print("[TikTok] Error: TIKTOK_SESSIONID is not set")
        print("[TikTok] Set it via --sessionid argument or TIKTOK_SESSIONID environment variable")
        sys.exit(1)

    # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    result = upload_to_tiktok(
        video_path=args.video,
        title=args.title,
        sessionid=sessionid,
        youtube_description=args.description
    )

    # Discordé€šçŸ¥
    discord_webhook = os.environ.get("DISCORD_WEBHOOK_URL")
    if discord_webhook:
        send_discord_notification(discord_webhook, result, args.title)

    # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆGitHub Actionsç”¨ï¼‰
    result_path = "tiktok_result.json"
    with open(result_path, 'w') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    if result["success"]:
        print("[TikTok] Done!")
        sys.exit(0)
    else:
        print(f"[TikTok] Failed: {result['error']}")
        # TikTokã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã¯å…¨ä½“ã‚’æ­¢ã‚ãªã„ï¼ˆexit 0ï¼‰
        sys.exit(0)


if __name__ == "__main__":
    main()
