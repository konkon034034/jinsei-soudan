# 年金ニュース動画自動生成システム - 技術ドキュメント

最終更新: 2025年12月22日

---

## 1. プロジェクト概要

### 1.1 概要
年金に関する最新ニュースを自動収集し、AI生成の掛け合い台本・音声・動画を作成してYouTubeに投稿するシステム。

### 1.2 対象チャンネル
- **チャンネル名**: 毎朝届く！おはよう年金ニュースラジオ
- **チャンネル番号**: TOKEN_23
- **配信時間**: 毎朝7:00 JST（自動投稿）

### 1.3 登場人物
| 名前 | 性別 | 役割 | 口調 |
|------|------|------|------|
| カツミ | 50代女性 | 年金専門家・解説役 | 落ち着いて優しく丁寧、控室では本音・毒舌 |
| ヒロシ | 40代前半男性 | 視聴者代弁・聞き役 | ちょっとお馬鹿でのんびり、素朴な疑問 |

### 1.4 動画構成
1. **オープニングジングル** - 番組開始
2. **オープニング** - 挨拶・今日のトピック紹介
3. **ニュースセクション** - 各ニュースの解説（複数）
4. **深掘りコーナー** - 1トピックを詳しく解説
5. **雑談まとめ** - 軽い会話調で振り返り
6. **本編エンディング** - 丁寧な締めの挨拶
7. **エンディングジングル** - 本編終了
8. **控え室パート** - 素のカツミ＆ヒロシの本音トーク（視聴者人気No.1）

---

## 2. ファイル構成

```
jinsei-soudan/
├── nenkin_news.py           # メインスクリプト（約4200行）
├── modal_video.py           # Modal GPU動画エンコーダー
├── requirements.txt         # Python依存関係
├── .github/
│   └── workflows/
│       └── nenkin_news.yml  # GitHub Actions設定
└── NENKIN_NEWS_DOCS.md      # 本ドキュメント
```

### 2.1 nenkin_news.py の構成

| 行番号 | 機能 |
|--------|------|
| 1-127 | 定数・設定（解像度、TTS設定、キャラクター設定） |
| 128-248 | 読み方辞書（TTS用） |
| 251-318 | GeminiKeyManager（APIキーローテーション） |
| 320-401 | Google認証・スプレッドシートログ |
| 403-546 | ニュース検索（Gemini Web Search） |
| 547-823 | 台本生成プロンプト（約280行の詳細プロンプト） |
| 826-1143 | 3重ファクトチェック（Gemini/Web/Claude） |
| 1147-1498 | TTS生成（Gemini TTS + Whisper STT） |
| 1600-1841 | Google Cloud TTS（フォールバック） |
| 2091-2424 | 音声処理（チャンク分割・結合・ジングル挿入） |
| 2450-2594 | ジングル・BGM処理 |
| 2669-2955 | 背景画像生成・トピックオーバーレイ |
| 2957-3108 | ASS字幕生成 |
| 3110-3449 | 動画生成（create_video） |
| 3452-3515 | YouTube投稿 |
| 3518-3715 | コメント・サムネイル生成 |
| 3717-3938 | サムネイル設定・コメント投稿 |
| 3985-4202 | main関数（全体フロー） |

---

## 3. ワークフロー全体の流れ

```
┌─────────────────────────────────────────────────────────────┐
│                    GitHub Actions                          │
│  (毎朝7:00 JST = UTC 22:00 または手動トリガー)               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [1/4] ニュース検索                                          │
│  - Gemini 2.0 Flash + Google Search grounding              │
│  - 確定情報/噂情報の分類                                    │
│  - 信頼できるソース判定                                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [2/4] 台本生成                                              │
│  - Gemini 2.0 Flash                                        │
│  - カツミ＆ヒロシの掛け合い台本（JSON形式）                  │
│  - 150〜200セリフ（本番）/ 18〜25セリフ（テスト）            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [2.5/4] 3重ファクトチェック                                 │
│  1. Gemini自己チェック                                      │
│  2. Web検索で裏取り                                         │
│  3. Claude APIでクロスチェック                              │
│  → エラーがあれば自動修正（最大3回リトライ）                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [3/4] 音声生成 (TTS)                                        │
│  - Gemini TTS (gemini-2.5-flash-preview-tts)               │
│  - マルチスピーカー設定（カツミ: Kore, ヒロシ: Puck）        │
│  - Whisper STTで正確なタイミング取得                        │
│  - セクション末尾にジングル自動挿入                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [3.5/4] 音声加工                                            │
│  - オープニングジングル追加                                 │
│  - 控え室BGM追加（ループ＋フェードアウト）                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [3.6/4] 動画エンコード                                      │
│  - Modal GPU (T4 GPU, h264_nvenc) または                   │
│  - ローカル CPU (libx264)                                   │
│  - ASS字幕合成                                              │
│  - 控え室から背景を黒に切り替え                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [4/7] サムネイル生成                                        │
│  - Geminiでキャッチーなタイトル生成                         │
│  - 背景画像 + 茶色バー + タイトル + 日付                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [5/7] YouTube投稿                                           │
│  - TOKEN_23チャンネルに限定公開                             │
│  - 概要欄自動生成（ソース・ハッシュタグ含む）               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [6/7] サムネイル設定 & 最初のコメント投稿                   │
│  - 70代老夫婦視点のコメントをGeminiで生成                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ [7/7] 通知                                                  │
│  - Discord Webhook通知                                      │
│  - スプレッドシートにログ記録                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 各機能の詳細

### 4.1 ニュース検索 (`search_pension_news`)
**場所**: `nenkin_news.py:424-546`

```python
# Gemini 2.0 Flash + Google Search grounding
client = genai_tts.Client(api_key=api_key)
response = client.models.generate_content(
    model="gemini-2.0-flash",
    contents=prompt,
    config=types.GenerateContentConfig(
        tools=[types.Tool(google_search=types.GoogleSearch())],
    )
)
```

**検索キーワード**:
- 年金 最新 今日
- 年金 ニュース [今月]
- 厚生年金 改正 最新
- 年金機構 発表 今週

**信頼できるソース** (`TRUSTED_SOURCES`):
- 厚生労働省 (mhlw.go.jp)
- 日本年金機構 (nenkin.go.jp)
- NHK (nhk.or.jp)
- 日本経済新聞 (nikkei.com)
- 読売新聞 (yomiuri.co.jp)
- 朝日新聞 (asahi.com)

### 4.2 台本生成 (`generate_script`)
**場所**: `nenkin_news.py:547-823`

出力形式（JSON）:
```json
{
  "title": "動画タイトル（30文字以内）",
  "description": "動画の説明文",
  "tags": ["タグ1", "タグ2"],
  "opening": [{"speaker": "カツミ", "text": "..."}],
  "news_sections": [
    {
      "news_title": "ニュースタイトル",
      "source": "出典名 YYYY/MM/DD",
      "dialogue": [...]
    }
  ],
  "deep_dive": [...],
  "chat_summary": [...],
  "ending": [...],
  "green_room": [...]
}
```

### 4.3 3重ファクトチェック (`triple_fact_check`)
**場所**: `nenkin_news.py:1087-1143`

| チェック | 関数 | 説明 |
|----------|------|------|
| 1. Gemini | `gemini_fact_check` | 台本と元ニュースの整合性確認 |
| 2. Web検索 | `web_search_fact_check` | 金額・日付を公式情報と照合 |
| 3. Claude | `claude_fact_check` | 別AIによるクロスチェック |

エラーがあれば `fix_script_errors` で自動修正（最大3回リトライ）

### 4.4 TTS生成 (`generate_unified_audio_with_stt`)
**場所**: `nenkin_news.py:1350-1495`

**処理フロー**:
1. 全台本を1回でGemini TTSに送信
2. マルチスピーカー設定で音声生成
3. Whisper STT (faster-whisper) でタイミング取得
4. 台本とSTT結果をマッチング

### 4.5 動画生成 (`create_video`)
**場所**: `nenkin_news.py:3110-3449`

**処理フロー**:
1. 台本をセクション別に整理
2. TTS音声生成（Gemini or Google Cloud）
3. オープニングジングル追加
4. 控え室BGM追加
5. ASS字幕生成
6. Modal GPU または ローカルCPUでエンコード

---

## 5. 使用しているAPI・サービス一覧

| サービス | 用途 | 備考 |
|----------|------|------|
| **Gemini API** | ニュース検索、台本生成、ファクトチェック、コメント生成 | 最大28キー対応 |
| **Gemini TTS** | 音声合成（マルチスピーカー） | gemini-2.5-flash-preview-tts |
| **Claude API** | ファクトチェック（クロスチェック） | claude-sonnet-4-20250514 |
| **Google Cloud TTS** | 音声合成（フォールバック） | WaveNet ja-JP |
| **YouTube Data API** | 動画投稿、サムネイル設定、コメント投稿 | OAuth2認証 |
| **Google Drive API** | ジングル・背景画像のダウンロード | サービスアカウント |
| **Google Sheets API** | 読み方辞書取得、実行ログ記録 | サービスアカウント |
| **Modal** | GPU動画エンコード | T4 GPU, h264_nvenc |
| **Discord Webhook** | 完了/エラー通知 | - |
| **faster-whisper** | 音声→テキストタイミング取得 | baseモデル、CPU |

---

## 6. 環境変数・Secrets一覧

### 6.1 必須

| 変数名 | 説明 |
|--------|------|
| `GOOGLE_SERVICE_ACCOUNT_KEY` | Google Cloud サービスアカウントJSON |
| `GEMINI_API_KEY` | Gemini APIキー（メイン） |
| `GEMINI_API_KEY_1` 〜 `GEMINI_API_KEY_28` | Gemini APIキー（追加分） |
| `YOUTUBE_CLIENT_ID` | YouTube OAuth2 クライアントID |
| `YOUTUBE_CLIENT_SECRET` | YouTube OAuth2 クライアントシークレット |
| `YOUTUBE_REFRESH_TOKEN_23` | YouTube OAuth2 リフレッシュトークン |
| `MODAL_TOKEN_ID` | Modal認証ID |
| `MODAL_TOKEN_SECRET` | Modal認証シークレット |

### 6.2 オプション

| 変数名 | 説明 | デフォルト |
|--------|------|------------|
| `CLAUDE_API_KEY` | Claude APIキー（ファクトチェック用） | - |
| `DISCORD_WEBHOOK_URL` | Discord通知用URL | - |
| `JINGLE_FILE_ID` | オープニングジングル（Google Drive） | - |
| `ENDING_JINGLE_FILE_ID` | エンディングジングル（Google Drive） | - |
| `BACKGROUND_IMAGE_ID` | 背景画像（Google Drive） | - |
| `TEST_MODE` | テストモード（短縮版） | false |
| `TTS_MODE` | TTSエンジン | gemini |
| `TTS_VOICE_FEMALE` | 女性音声 | Kore |
| `TTS_VOICE_MALE` | 男性音声 | Puck |
| `USE_MODAL_GPU` | Modal GPU使用 | true |

### 6.3 Google Drive ファイルID

| 用途 | 変数/定数 | ファイルID |
|------|-----------|------------|
| 通常ジングル | `NORMAL_JINGLE_ID` | 18JF1p4Maea9SPcZ6y0wCHnxI1FMAfyfT |
| 控え室ジングル | `GREEN_ROOM_JINGLE_ID` | 1zaJf-Oq7gzR26k33y2ccTS0yO_n5gY83 |
| 控え室BGM | `BACKROOM_BGM_FILE_ID` | 1wP6bp0a0PlaaqM55b8zdwozxT0XTOvab |
| 読み方辞書スプレッドシート | `READING_DICT_SPREADSHEET_ID` | 15_ixYlyRp9sOlS0tdklhz6wQmwRxWlOL9cPndFWwOFo |

---

## 7. 台本生成のプロンプト全文

**場所**: `nenkin_news.py:583-808`

```
あなたは年金ニュース番組の台本作家です。
以下のニュースを元に、カツミとヒロシの掛け合い台本を作成してください。

【登場人物】
- カツミ（50代女性）: 年金の専門家、解説役。落ち着いていて優しく丁寧だけど、控室では本音が出る。
- ヒロシ（40代前半男性）: 視聴者代弁、素朴な疑問を聞く。ちょっとお馬鹿でのんびり。

【台本構成】
1. オープニング
   - 「おはようございます。○月○日の年金ニュースをお届けします」
   - 今日のトピック紹介

2. 各ニュースセクション（複数）
   - 出典を明記「○○年○月○日、厚生労働省によりますと...」
   - 具体的な数字を入れる（○万円、○%増など）
   - 専門用語は必ず説明「iDeCo、つまり個人型確定拠出年金ですね」
   - ヒロシが素朴な疑問「それって私たちにどう影響するの?」

3. 深掘りコーナー
   - 2つの視点や仮説を提示
   - メリット・デメリットを整理

4. 雑談風まとめ
   - 軽い会話調で振り返り

5. 本編エンディング（丁寧モード）
   - 「本日もお聴きいただきありがとうございました」
   - 「また明日お会いしましょう」

6. 控え室パート【最重要：視聴者が最も楽しみにするパート】
   - 素のカツミ＆ヒロシ
   - 本音ダダ漏れ、噂話、毒舌全開
   - 最後は前向きに

【ルール】
- 各セリフは50文字以内
- 出典を明記
- 具体的な金額・日付・%を入れる
- 専門用語は必ず噛み砕いて説明
- 数字で損得をわかりやすく（年間/月/1日換算）

【禁止表現】
- 「こちら」「あちら」「ここ」等のリンクを指す表現
  NG: 「詳しくはこちらで確認を」
  OK: 「詳しくは年金機構のホームページで確認できます」

【控室の始め方】
控室パートは必ず「お疲れ様」系の言葉から自然に始める
```

---

## 8. TTS設定

### 8.1 Gemini TTS設定

**場所**: `nenkin_news.py:58-96`

```python
GEMINI_TTS_MODEL = "gemini-2.5-flash-preview-tts"

# 利用可能: Puck, Charon, Kore, Fenrir, Aoede
TTS_VOICE_FEMALE = "Kore"   # カツミ
TTS_VOICE_MALE = "Puck"     # ヒロシ
```

**TTS指示文** (`TTS_INSTRUCTION`):
```
あなたはプロフェッショナルな年金ニュース番組のパーソナリティです。

【カツミの声の特徴（Kore音声を使用）】
- 50代女性の落ち着いた声
- トーン: 低め、温かみがある、信頼感がある
- スピード: ゆっくり目（1.0倍速）

【ヒロシの声の特徴（Puck音声を使用）】
- 40代前半男性の素朴な声
- トーン: 中程度、明るい、親しみやすい、のんびり
- スピード: 普通（1.0倍速）

【台本の読み上げルール】
- [カツミ] で始まる行はカツミの声で読む
- [ヒロシ] で始まる行はヒロシの声で読む
- 話者名は読み上げず、セリフ部分のみ読む
```

### 8.2 Google Cloud TTS設定（フォールバック）

**場所**: `nenkin_news.py:104-121`

```python
GCLOUD_VOICE_KATSUMI = "ja-JP-Wavenet-A"  # 女性
GCLOUD_VOICE_HIROSHI = "ja-JP-Wavenet-D"  # 男性
```

### 8.3 読み方辞書

**場所**: `nenkin_news.py:128-192`

**スプレッドシート**: `15_ixYlyRp9sOlS0tdklhz6wQmwRxWlOL9cPndFWwOFo` (シート: 読み方辞書)

**デフォルト辞書** (`DEFAULT_READING_DICT`):

| 元表記 | 読み方 |
|--------|--------|
| iDeCo | イデコ |
| NISA | ニーサ |
| つみたてNISA | つみたてニーサ |
| 新NISA | しんニーサ |
| GPIF | ジーピーアイエフ |
| 厚労省 | こうろうしょう |
| 年金機構 | ねんきんきこう |
| 401k | よんまるいちけー |
| GDP | ジーディーピー |
| 月収 | げっしゅう |
| 月収入 | げっしゅうにゅう |
| 2024年 | にせんにじゅうよねん |
| 2025年 | にせんにじゅうごねん |
| ... | ... |

---

## 9. 動画レイアウト

### 9.1 解像度
```python
VIDEO_WIDTH = 1920
VIDEO_HEIGHT = 1080
```

### 9.2 画面構成

```
┌────────────────────────────────────────────────────────┐
│                                                        │
│                    背景画像                             │
│                    (Google Driveから取得               │
│                     または ベージュグラデーション)       │
│                                                        │
│                              ┌───────────────────┐     │
│                              │  日付 (右上)       │     │
│                              │  トピックボックス  │     │
│                              └───────────────────┘     │
│                                                        │
├────────────────────────────────────────────────────────┤ ← Y=594 (画面の45%)
│  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  │
│  ▓  茶色半透明バー (rgba(60,40,30,0.8))              ▓  │
│  ▓                                                   ▓  │
│  ▓     字幕（白文字、3行まで折り返し）               ▓  │
│  ▓     ・通常セクション: 白文字                      ▓  │
│  ▓     ・控え室セクション: 白文字                    ▓  │
│  ▓                                                   ▓  │
│  ▓  出典: 厚生労働省 2024/12/20 (グレー、右下)       ▓  │
│  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  │
└────────────────────────────────────────────────────────┘

※控え室パート開始時: 背景を真っ黒に切り替え、透かしバーも非表示
```

### 9.3 字幕設定 (ASS)

**場所**: `nenkin_news.py:2957-3108`

| スタイル | フォント | サイズ | 色 | 用途 |
|----------|----------|--------|-----|------|
| Default | Noto Sans CJK JP | 144px | 白 | 通常セリフ |
| Backroom | Noto Sans CJK JP Medium | 144px | 白 | 控え室セリフ |
| Source | Noto Sans CJK JP | 48px | グレー | 出典表示 |
| Topic | Noto Sans CJK JP | 96px | 白 | トピック名 |
| BackroomTitle | Noto Sans CJK JP | 180px | 白 | 「控室にて。」 |

### 9.4 サムネイル設定

**場所**: `nenkin_news.py:3653-3815`

```python
THUMBNAIL_WIDTH = 1280
THUMBNAIL_HEIGHT = 720
```

構成:
- 背景画像
- 下部40%に茶色半透明バー
- キャッチーなタイトル（Gemini生成、72px）
- 右上に日付

---

## 10. ジングル・BGM設定

### 10.1 ジングル

| 用途 | Google Drive ID | タイミング |
|------|-----------------|------------|
| オープニング | `JINGLE_FILE_ID` (環境変数) | 動画冒頭 (+6dB) |
| 通常セクション末尾 | `18JF1p4Maea9SPcZ6y0wCHnxI1FMAfyfT` | 各セクション終了時 (+3dB) |
| 控え室セクション末尾 | `1zaJf-Oq7gzR26k33y2ccTS0yO_n5gY83` | 控え室終了時 (+3dB) |

### 10.2 BGM

| 用途 | Google Drive ID | 設定 |
|------|-----------------|------|
| 控え室BGM | `1wP6bp0a0PlaaqM55b8zdwozxT0XTOvab` | 原音、ループ、最後5秒フェードアウト |

**場所**: `nenkin_news.py:3279-3332`

---

## 11. ファクトチェックの仕組み

**場所**: `nenkin_news.py:826-1143`

### 11.1 抽出対象

`extract_facts_from_script` で台本から以下を抽出:
- 金額パターン: `[\d,]+(?:万|億|兆)?円`
- パーセント: `[\d.]+(?:%|パーセント|ポイント)`
- 年齢: `\d+歳`
- 日付: `(?:\d+年)?\d+月\d*日?|来年度|今年度|令和\d+年`

### 11.2 チェックフロー

```
┌─────────────────┐
│  台本生成完了    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     エラーあり
│ Geminiチェック   │────────────┐
│ (自己チェック)   │            │
└────────┬────────┘            │
         │ OK                   │
         ▼                      │
┌─────────────────┐     エラーあり
│ Web検索チェック  │────────────┤
│ (公式情報照合)   │            │
└────────┬────────┘            │
         │ OK                   │
         ▼                      │
┌─────────────────┐     エラーあり
│ Claudeチェック   │────────────┤
│ (クロスチェック) │            │
└────────┬────────┘            │
         │ OK                   ▼
         │              ┌───────────────┐
         │              │ 台本を自動修正 │
         │              │ (最大3回)      │
         │              └───────┬───────┘
         │                      │
         ▼                      │
┌─────────────────┐◀────────────┘
│  チェック完了    │
└─────────────────┘
```

---

## 12. GitHub Actions設定

**ファイル**: `.github/workflows/nenkin_news.yml`

### 12.1 トリガー

```yaml
on:
  schedule:
    - cron: '0 22 * * *'  # 毎朝7:00 JST = UTC 22:00
  workflow_dispatch:       # 手動実行
```

### 12.2 手動実行パラメータ

| パラメータ | デフォルト | 選択肢 |
|------------|------------|--------|
| test_mode | true | true / false |
| tts_mode | gemini | gemini / google_cloud |
| use_modal_gpu | true | true / false |
| tts_voice_female | Kore | Kore / Aoede / Charon |
| tts_voice_male | Puck | Puck / Fenrir / Charon |

### 12.3 実行ステップ

1. リポジトリチェックアウト
2. Python 3.11 セットアップ
3. システム依存関係インストール (ffmpeg, fonts-noto-cjk)
4. pip install -r requirements.txt
5. Modal関数デプロイ (`modal deploy modal_video.py`)
6. `python nenkin_news.py` 実行
7. 成果物アップロード (mp4ファイル、3日保持)
8. Discord通知 (成功/失敗)

### 12.4 タイムアウト

- ワークフロー全体: 60分

---

## 13. Modal GPU設定

**ファイル**: `modal_video.py`

### 13.1 アプリ設定

```python
app = modal.App("nenkin-video")
```

### 13.2 イメージ設定

```python
image = modal.Image.debian_slim().apt_install(
    "ffmpeg",
    "fonts-noto-cjk",
    "fonts-noto-cjk-extra",
    "fontconfig"
).run_commands(
    "fc-cache -f -v"
).pip_install(
    "numpy"
)
```

### 13.3 GPU関数

```python
@app.function(gpu="T4", image=image, timeout=600)
def encode_video_gpu(bg_base64, audio_base64, ass_content, output_name, backroom_start_sec=None):
    # h264_nvenc でエンコード
    # GPU非対応時はlibx264にフォールバック
```

### 13.4 ffmpegコマンド

```bash
ffmpeg -y \
  -loop 1 -i bg.png \
  -i audio.wav \
  -vf "scale=1920:1080,\
       drawbox=x=0:y=0:w=1920:h=1080:color=black:t=fill:enable='gte(t,{backroom_start_sec})',\
       drawbox=x=0:y=594:w=1920:h=486:color=0x3C281E@0.8:t=fill:enable='lt(t,{backroom_start_sec})',\
       ass=subtitles.ass:fontsdir=/usr/share/fonts" \
  -c:v h264_nvenc -preset fast -b:v 5M \
  -c:a aac -b:a 192k \
  -shortest -pix_fmt yuv420p -movflags +faststart \
  output.mp4
```

---

## 14. 現在の課題・改善案

### 14.1 既知の課題

| カテゴリ | 課題 | 対応状況 |
|----------|------|----------|
| TTS | Gemini TTS 429エラー（レート制限） | 複数APIキーでローテーション対応 |
| TTS | 声の一貫性（途中で声質が変わることがある） | 全セリフ1チャンク生成で対応 |
| 音声 | Whisper STTのマッチング精度 | difflib + 前後5セグメント検索で改善 |
| 動画 | ローカルCPUエンコードが遅い | Modal GPU対応で解決 |

### 14.2 改善案

1. **音声品質向上**
   - ElevenLabs TTS の検討（より自然な日本語）
   - 音声の感情表現強化

2. **コンテンツ拡充**
   - 過去ニュースとの関連付け
   - 視聴者質問への回答コーナー

3. **効率化**
   - キャッシュ機能（同じニュースの再処理回避）
   - 並列処理の最適化

4. **視聴者エンゲージメント**
   - インタラクティブな質問機能
   - コメント返信の自動化

---

## 15. 今後のTODO

### 15.1 短期（〜1ヶ月）

- [ ] 字幕タイミングの精度向上（Whisper large モデル検討）
- [ ] サムネイルのA/Bテスト機能
- [ ] 動画長の最適化（目標: 15〜20分）

### 15.2 中期（1〜3ヶ月）

- [ ] リスナー投稿コーナー機能
- [ ] 週間まとめ動画の自動生成
- [ ] YouTubeアナリティクス連携

### 15.3 長期（3ヶ月〜）

- [ ] マルチチャンネル展開（年金以外のテーマ）
- [ ] ライブ配信機能
- [ ] 視聴者コミュニティ機能

---

## 付録A: コマンドラインからの実行

### テストモード実行
```bash
TEST_MODE=true python nenkin_news.py
```

### 本番モード実行
```bash
TEST_MODE=false python nenkin_news.py
```

### GitHub Actionsからテスト実行
```bash
gh workflow run nenkin_news.yml -f test_mode=true
```

---

## 付録B: トラブルシューティング

### B.1 TTS 429エラー

**症状**: `RESOURCE_EXHAUSTED` エラーが頻発

**対策**:
1. APIキーを追加（`GEMINI_API_KEY_N`）
2. チャンク間隔を広げる
3. Google Cloud TTSにフォールバック

### B.2 YouTube投稿エラー

**症状**: `YOUTUBE_REFRESH_TOKEN_23` が無効

**対策**:
1. OAuth2トークンを再取得
2. Secretsを更新

### B.3 Modal GPUエラー

**症状**: GPU非対応エラー

**対策**:
1. Modal Secretsを確認
2. `USE_MODAL_GPU=false` でCPUフォールバック

---

*このドキュメントは自動生成システムの現時点の実装を反映しています。*
