name: Test Upload All Channels

on:
  workflow_dispatch:

jobs:
  test-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto-cjk

      - name: Install Python dependencies
        run: |
          pip install python-dotenv google-auth google-auth-oauthlib google-auth-httplib2
          pip install google-api-python-client requests
          pip install moviepy>=2.0.0

      - name: Run test upload
        id: upload
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          TOKEN_5: ${{ secrets.YOUTUBE_REFRESH_TOKEN_5 }}
          TOKEN_6: ${{ secrets.YOUTUBE_REFRESH_TOKEN_6 }}
          TOKEN_7: ${{ secrets.YOUTUBE_REFRESH_TOKEN_7 }}
          TOKEN_9: ${{ secrets.YOUTUBE_REFRESH_TOKEN_9 }}
          TOKEN_11: ${{ secrets.YOUTUBE_REFRESH_TOKEN_11 }}
          TOKEN_12: ${{ secrets.YOUTUBE_REFRESH_TOKEN_12 }}
          TOKEN_13: ${{ secrets.YOUTUBE_REFRESH_TOKEN_13 }}
          TOKEN_15: ${{ secrets.YOUTUBE_REFRESH_TOKEN_15 }}
          TOKEN_16: ${{ secrets.YOUTUBE_REFRESH_TOKEN_16 }}
          TOKEN_17: ${{ secrets.YOUTUBE_REFRESH_TOKEN_17 }}
          TOKEN_18: ${{ secrets.YOUTUBE_REFRESH_TOKEN_18 }}
          TOKEN_19: ${{ secrets.YOUTUBE_REFRESH_TOKEN_19 }}
          TOKEN_20: ${{ secrets.YOUTUBE_REFRESH_TOKEN_20 }}
          TOKEN_21: ${{ secrets.YOUTUBE_REFRESH_TOKEN_21 }}
          TOKEN_22: ${{ secrets.YOUTUBE_REFRESH_TOKEN_22 }}
          TOKEN_26: ${{ secrets.YOUTUBE_REFRESH_TOKEN_26 }}
          TARGET_CHANNELS: "5,6,7,9,11,12,13,15,16,17,18,19,20,21,22,26"
        run: |
          python scripts/test_upload_27ch.py 2>&1 | tee upload_result.txt
          echo "result<<EOF" >> $GITHUB_OUTPUT
          cat upload_result.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set, skipping notification"
            exit 0
          fi

          # Get summary from result
          SUCCESS_COUNT=$(grep -oP '成功:\d+' upload_result.txt | grep -oP '\d+' || echo "0")
          FAILED_COUNT=$(grep -oP '失敗:\d+' upload_result.txt | grep -oP '\d+' || echo "0")

          if [ "$FAILED_COUNT" = "0" ] && [ "$SUCCESS_COUNT" != "0" ]; then
            STATUS=":white_check_mark: 全チャンネル成功"
            COLOR="good"
          elif [ "$SUCCESS_COUNT" = "0" ]; then
            STATUS=":x: 全チャンネル失敗"
            COLOR="danger"
          else
            STATUS=":warning: 一部失敗"
            COLOR="warning"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"27チャンネル テストアップロード結果\",
                \"text\": \"$STATUS\n成功: ${SUCCESS_COUNT}件 / 失敗: ${FAILED_COUNT}件 / 合計: 16件\",
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL"
