name: Bakenami Video Daily Generation

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate-video:
    runs-on: ubuntu-latest
    
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
      BACKGROUND_IMAGE_ID: ${{ secrets.BACKGROUND_IMAGE_ID }}
      CHARACTER1_IMAGE_ID: ${{ secrets.CHARACTER1_IMAGE_ID }}
      CHARACTER2_IMAGE_ID: ${{ secrets.CHARACTER2_IMAGE_ID }}
      BGM_FILE_ID: ${{ secrets.BGM_FILE_ID }}
      EPISODE_NUMBER: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # â­ ä¿®æ­£: python3-dev ã‚’è¿½åŠ ã—ã€pydubã®ã‚¨ãƒ©ãƒ¼ (audioop/pyaudioop) ã‚’è§£æ¶ˆã—ã¾ã™
      - name: Install dependencies (incl. ffmpeg, gtts, pydub)
        run: |
          # å‹•ç”»ç”Ÿæˆã«å¿…è¦ãªFFmpegã¨pydubã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-dev
          # Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install -r requirements.txt
          
      # â­ ãƒ­ã‚°ã‚’ run_log.txt ã«å‡ºåŠ›ã—ã€å¤±æ•—ã—ã¦ã‚‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™
      - name: Run Bakenami Video Generator and Capture Log
        run: python bakenami_generator.py > run_log.txt 2>&1 || true

      # â­ å¾©å…ƒ: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œãƒ­ã‚°ã‚’ä¿å­˜
      - name: Upload Run Log ğŸ“
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-run-log
          path: run_log.txt
          retention-days: 7
          
      # â­ å¾©å…ƒ: ä½œæˆã•ã‚ŒãŸå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ (ã“ã‚ŒãŒãªã„ã¨å‹•ç”»ãŒæ¶ˆãˆã¾ã™)
      - name: Upload video artifact ğŸ’¾
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-video-output
          path: output/*.mp4
          retention-days: 7

      - name: Clean up temporary files
        if: always()
        run: |
          echo "Cleaning up temp directories..."
          rm -rf output
          rm -rf temp
