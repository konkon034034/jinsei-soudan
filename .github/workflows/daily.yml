name: Bakenami Video Daily Generation

on:
  # æ¯æ—¥åˆå‰9æ™‚ (JST) ã«å®Ÿè¡Œ (UTCã§æ·±å¤œ0æ™‚)
  schedule:
    - cron: '0 0 * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

jobs:
  generate-video:
    runs-on: ubuntu-latest
    
    # ç’°å¢ƒå¤‰æ•°ã‚’ä¸€æ‹¬è¨­å®š
    env:
      # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã«å¿…è¦ãªå…¨ã¦ã®ç’°å¢ƒå¤‰æ•°ã‚’GitHub Secretsã‹ã‚‰èª­ã¿è¾¼ã‚€
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
      SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
      BACKGROUND_IMAGE_ID: ${{ secrets.BACKGROUND_IMAGE_ID }}
      CHARACTER1_IMAGE_ID: ${{ secrets.CHARACTER1_IMAGE_ID }}
      CHARACTER2_IMAGE_ID: ${{ secrets.CHARACTER2_IMAGE_ID }}
      BGM_FILE_ID: ${{ secrets.BGM_FILE_ID }}
      
      # åˆå›å®Ÿè¡Œç”¨ã«ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç•ªå·ã‚’è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦Secretsã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
      EPISODE_NUMBER: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (incl. ffmpeg, gtts, pydub)
        run: |
          # å‹•ç”»ç”Ÿæˆã«å¿…è¦ãªFFmpegã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          # Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install -r requirements.txt
          
      - name: Run Bakenami Video Generator
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã€‚æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’æ¨™æº–å‡ºåŠ›ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ (2>&1)
        run: python bakenami_generator.py

      # â­â­â­ è¿½è¨˜éƒ¨åˆ†: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (Artifact) ã‚’GitHubã«ä¿å­˜ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ— â­â­â­
      - name: Upload video artifact ğŸ’¾
        uses: actions/upload-artifact@v4
        # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã‚‚ï¼ˆä¾‹ãˆã°YouTubeã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ï¼‰ã€ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å®Ÿè¡Œã™ã‚‹
        if: always()
        with:
          name: generated-video-output # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«å
          path: output/*.mp4            # outputãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ã¦ã®mp4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          retention-days: 7             # ä¿å­˜æœŸé–“ (7æ—¥é–“)
      # â­â­â­ è¿½è¨˜çµ‚ã‚ã‚Š â­â­â­

      - name: Clean up temporary files
        if: always()
        run: |
          echo "Cleaning up temp directories..."
          rm -rf output
          rm -rf temp
