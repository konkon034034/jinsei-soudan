name: Generate Video

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'Channel number (23, 24, or 27)'
        required: true
        default: '23'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-noto-cjk
          pip install google-auth google-auth-oauthlib google-api-python-client
          pip install gspread requests moviepy>=2.0.0 openai

      - name: Generate and upload video
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          TOKEN_23: ${{ secrets.YOUTUBE_REFRESH_TOKEN_23 }}
          TOKEN_24: ${{ secrets.YOUTUBE_REFRESH_TOKEN_24 }}
          TOKEN_27: ${{ secrets.YOUTUBE_REFRESH_TOKEN_27 }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CHANNEL_NUM: ${{ github.event.inputs.channel }}
        run: |
          python3 scripts/generate_and_upload.py

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CHANNEL_NUM: ${{ github.event.inputs.channel }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not set"
            exit 0
          fi

          if [ "${{ job.status }}" = "success" ]; then
            STATUS=":white_check_mark: 成功"
            COLOR="good"
          else
            STATUS=":x: 失敗"
            COLOR="danger"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"ch${CHANNEL_NUM} 動画生成\",
                \"text\": \"$STATUS\",
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL"
