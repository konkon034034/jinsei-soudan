name: Test YouTube Token

on:
  workflow_dispatch:
    inputs:
      token_number:
        description: 'Token number to test'
        required: true
        default: '23'

jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Test YouTube Token
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets[format('YOUTUBE_REFRESH_TOKEN_{0}', github.event.inputs.token_number)] }}
        run: |
          echo "Testing TOKEN_${{ github.event.inputs.token_number }}..."

          # Get access token
          RESPONSE=$(curl -s -X POST https://oauth2.googleapis.com/token \
            -d "client_id=$YOUTUBE_CLIENT_ID" \
            -d "client_secret=$YOUTUBE_CLIENT_SECRET" \
            -d "refresh_token=$YOUTUBE_REFRESH_TOKEN" \
            -d "grant_type=refresh_token")

          ACCESS_TOKEN=$(echo $RESPONSE | jq -r '.access_token')

          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "❌ Token invalid or expired"
            echo "Error: $(echo $RESPONSE | jq -r '.error_description // .error')"
            exit 1
          fi

          # Get channel info
          CHANNEL=$(curl -s "https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true" \
            -H "Authorization: Bearer $ACCESS_TOKEN")

          CHANNEL_NAME=$(echo $CHANNEL | jq -r '.items[0].snippet.title // "Unknown"')
          CHANNEL_ID=$(echo $CHANNEL | jq -r '.items[0].id // "Unknown"')

          echo "✅ Token is valid!"
          echo "Channel: $CHANNEL_NAME"
          echo "ID: $CHANNEL_ID"
